<!DOCTYPE html>
<meta charset="utf-8">
<style>
    h3 {
        margin: 0px 0px 0px 0px; 
        padding: 0px 0px 0px 0px;
    }
    h5 {
        margin: 0px 0px 0px 0px; 
        padding: 0px 0px 0px 0px;
    }
    .mapSVG{
        align-items: center;
        justify-content: center;
        display: flex;
        baseline-shift: 100px
    }
    .state{
        stroke: #a9a9a9;
        stroke-width: 1;
    }
    .state:hover{
        fill-opacity:0.5;
    }
    #tooltip {   
        position: absolute;           
        text-align: center;
        text-anchor: middle;
        padding: 20px;             
        margin: 10px;
        font: 12px sans-serif;        
        background: lightsteelblue;   
        border: 1px;      
        border-radius: 2px;           
        pointer-events: none;         
    }
    #tooltip h4{
        margin:0;
        font-size:14px;
    }
    #tooltip{
        background:rgba(0,0,0,0.9);
        border:1px solid grey;
        border-radius:5px;
        font-size:12px;
        width:auto;
        padding:4px;
        color:white;
        opacity:0;
    }
    #tooltip table{
        table-layout:fixed;
    }
    #tooltip tr td{
        padding:0;
        margin:0;
    }
    #tooltip tr td:nth-child(1){
        width:50px;
    }
    #tooltip tr td:nth-child(2){
        text-align:center;
    }
    .axis .domain {
        display: none;
    }
    #tooltip2 {   
        position: absolute;           
        text-align: center;
        text-anchor: middle;
        padding: 20px;             
        margin: 10px;
        font: 12px sans-serif;        
        background: lightsteelblue;   
        border: 1px;      
        border-radius: 2px;           
        pointer-events: none;         
    }
    #tooltip2 h4{
        margin:0;
        font-size:14px;
    }
    #tooltip2{
        background:rgba(0,0,0,0.9);
        border:1px solid grey;
        border-radius:5px;
        font-size:12px;
        width:auto;
        padding:4px;
        color:white;
        opacity:0;
    }
    #tooltip2 table{
        table-layout:fixed;
    }
    #tooltip2 tr td{
        padding:0;
        margin:0;
    }
    #tooltip2 tr td:nth-child(1){
        width:50px;
    }
    #tooltip2 tr td:nth-child(2){
        text-align:center;
    }

</style>

<!----------------------------------------------------------------------------
  ----------------------------------------------------------------------------
  ----------------------------- US Map Viz Code ------------------------------
  ----------------------------------------------------------------------------
  --------------------------------------------------------------------------->

<body>
<h3 align="center">Mid-Career Median Salary Map <!-- Viz Title -->
    <!-- Viz Description -->
    <h5 align="center"> States numbers are the average Median Mid-Career Salary over the colleges within the state.</h5> 
    <h5 align="center"> College numbers are the Median Mid-Career Salary for the college itself.</h5>
    <h5 align="center">Clicking on a college will filter the Earnings by Major Visualization to display only the top 5 majors from the selected college.</h5>
</h3>
<div id="tooltip"></div><!-- tooltip div -->
<div align="center" id="map"></div> <!-- map div -->
<script src="uStates.js"></script> <!-- creates uStates. -->
<script src="d3.min.js"></script>
<script src="jquery-3.1.0.min.js"></script>
<script>

    // Heat map color scale projection variable 
    var heat = d3.scale.ordinal()
        .domain([0, 1, 2, 3, 4])
        .range(["#BB2528", "#EA4630", "#F8B229", "#9ACD32", "#165B33"]);

    // Function to create HTML content string in tooltip
    function school_tooltipHtml(words){ 
        return "<h4>" + words + "</h4><table>"+"</table>";
    }

    // Function to handle mouseover event for a college
    function school_mouseOver(d){
        d3.select("#tooltip").transition().duration(200).style("opacity", .9);
        d3.select("#tooltip").html(school_tooltipHtml(d["School Name"] + ": " + d["Mid-Career Median Salary"]))
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");
    }
        
    // Function to handle mouseout event
    function mouseOut(){
        d3.select("#tooltip").transition().duration(500).style("opacity", 0); 
    }

    // Function to handle a click event for a college
    function click(d){
        d3.select("#chartSVG").remove();
        draw_bar([d["1st"], d["2nd"], d["3rd"], d["4th"], d["5th"]])
    }
    
    // State abbreviations
    var stateData ={};
    ["HI", "AK", "FL", "SC", "GA", "AL", "NC", "TN", "RI", "CT", "MA",
    "ME", "NH", "VT", "NY", "NJ", "PA", "DE", "MD", "WV", "KY", "OH", 
    "MI", "WY", "MT", "ID", "WA", "DC", "TX", "CA", "AZ", "NV", "UT", 
    "CO", "NM", "OR", "ND", "SD", "NE", "IA", "MS", "IN", "IL", "MN", 
    "WI", "MO", "AR", "OK", "KS", "LS", "VA"];
    
    // Function to draw the map viz to the screen    
    function draw_map(){

        // SVG object
        var svg = d3.select("#map").append("svg")
                    .attr("id", "mapSVG")
                    .attr("width", 960)
                    .attr("height", 600),
        width = +svg.attr("width"),
        height = +svg.attr("height");
        g = svg.append("g");

        // Draw states on map svg 
        uStates.draw("#mapSVG", stateData, heat, school_tooltipHtml);

        // Projection variable for mapping college locations
        var projection = d3.geo.albersUsa().scale(1250).translate([width / 2 - (width/192), height / 2 - (height/43)]);

        // Read data fromm CSV for map viz
        d3.csv("master_data.csv", function(data){
            d3.select("#mapSVG").selectAll("circle")
            .data(data)
            .enter().append("circle")
            .each(function(d){
                try{
                    var pos = projection([parseFloat(d["Longitude"]), parseFloat(d["Latitude"])]);
                    d.cx = pos[0];
                    d.cy = pos[1];
                }
                catch(error){
                    d.cx = 282;     // Hawaii cx-value
                    d.cy = 530;     // Hawaii cy-value
                }
            })
            .attr("cy", function(d){ return d.cy; })
            .attr("cx", function(d){ return d.cx; }) 
            .attr("r", 2)
            .style("fill", "black")
            .style("opacity", 1)
            .on("mouseover", school_mouseOver)
            .on("mouseout", mouseOut)
            .on("click", click);

            // Append legend object
            var legend = g.append("g")
                            .attr("font-family", "sans-serif")
                            .attr("font-size", 10)
                            .attr("text-anchor", "end")
                            .selectAll("g")
                            .data([0, 1, 2, 3, 4])
                          .enter().append("g")
                            .attr("transform", function(d, i) { 
                                return "translate(275," + (410 + i * 20) + ")"; });

            // Append legend colored squares 
            legend.append("rect")
                .attr("x", width - 295)
                .attr("width", 19)
                .attr("height", 19)
                .attr("fill", function(d){ return heat(d)});

            // Append legend text
            legend.append("text")
                .attr("x", width - 300)
                .attr("y", 9.5)
                .attr("dy", "0.32em")
                .style("font-size", "8px")
                .style("font-weight", "bold")
                .text(function(d) {
                    switch(d){
                        case 0: return "$60,000 - $69,999"; break;
                        case 1: return "$70,000 - $79,999"; break;
                        case 2: return "$80,000 - $89,999"; break;
                        case 3: return "$90,000 - $99,999"; break;
                        case 4: return "$100,000 - $110,000"; break;
                    }
                });

            // Append legend title (Part 1)
            d3.select("#mapSVG").append("text")
                .attr("x", width - 95)
                .attr("y", height - 215)
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text("Mean Mid-Career");

            // Append legend title (Part 2)
            d3.select("#mapSVG").append("text")
                .attr("x", width - 90)
                .attr("y", height - 200)
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text("Median Salary");
        })
    }
    
</script>

<!----------------------------------------------------------------------------
  ----------------------------------------------------------------------------
  ------------------------- College Major Viz Code ---------------------------
  ----------------------------------------------------------------------------
  --------------------------------------------------------------------------->

<h3>Earnings by Major</h3> <!-- Viz Title -->
<h5> Click anywhere on the viz to reset the chart</h5> <!-- Viz Description -->
<div id="tooltip2"></div><!-- tooltip div -->
<div align="left" id="chart"></div> <!-- stacked bar chart div -->
<script src="d3.v4.min.js"></script>
<script>

// Function to create HTML content string in tooltip
function tooltipHtml(words){
  return "<h4>"+ words +"</h4><table>"+"</table>";
}

// Function to react to mouseover on rectangle object in stacked bar chart
function rect_mouseOver(d){
    // Pull label for hover-over rectangle
    options = Object.keys(d.data);
    var label;
    for(var i = 0; i < options.length; i++){
        if(d.data[options[i]] == d[1] - d[0])
            label = options[i];
    }

    d3.select("#tooltip2").transition().duration(200).style("opacity", .9)     
    d3.select("#tooltip2").html(tooltipHtml(d.data["Major"] + " " + label + ": $" + d[1].toLocaleString()))  
      .style("left", (d3.event.pageX) + "px")     
      .style("top", (d3.event.pageY - 28) + "px");
}

// Function to react to mouseover on circle object in stacked bar chart
function circle_mouseOver(d){
    d3.select("#tooltip2").transition().duration(200).style("opacity", .9);
    d3.select("#tooltip2").html(tooltipHtml(d["Major"] + " Starting Median Salary: $" + Math.round(d["Starting Median Salary"]).toLocaleString()))
      .style("left", (d3.event.pageX) + "px")     
      .style("top", (d3.event.pageY - 28) + "px");
}

// Function to react to mouseout on object in stacked bar chart
function mouseOut(){
    d3.select("#tooltip2").transition().duration(500).style("opacity", 0);
}

// Function to draw the horizontal stacked bar chart for college major earnings
function draw_bar(filter){

    // SVG object and parameters      
    var svg = d3.select("#chart").append("svg")
                .attr("id", "chartSVG")
                .attr("width", Number(d3.select("#chart").style("width").slice(0,-2))/2)
                .attr("height", 600),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Projection to y dimension (Major)
    var y = d3.scaleBand()
        .rangeRound([0, height])   
        .paddingInner(0.05)
        .align(0.1);

    // Projection to x dimension (Salary)
    var x = d3.scaleLinear()       
        .rangeRound([0, width-250]);

    // Projection to z dimension (Color)
    var z = d3.scaleOrdinal()
        .range(["#173F5F", "#20639B", "#3CAEA3", "#F6D55C", "#ED553B"].reverse());

    // Read data from CSV
    d3.csv("degrees.csv", function(d, i, columns) {

        // Sum the total for each major over all Mid-Career Salary columns
        for (var i = 1, t = 0; i < columns.length-1; ++i) 
            t += d[columns[i]] = +d[columns[i]];
            d.total = t;
            return d;
        }, 

        // Function to draw horizontal stacked bar chart
        function(error, data){
            if (error) throw error;
            

            var keys = data.columns.slice(1);   // Slice major name from keys
            keys = keys.slice(0,5);   // Slice Starting Median Salary from keys
            
            // Sort data by total earnings
            data.sort(function(a, b){ return b.total - a.total; }); 

            // If filter applied from map, filter data
            if(filter.length != 0){
                new_data = [];
                for(var i = 0; i < filter.length; i++){
                    for(var j = 0; j < data.length; j++){
                        if(filter[i].trim() == data[j]["Major"].trim())
                            new_data.push(data[j])
                    }
                }
                data = new_data;
            }
           
            // Sset domain for x, y, and z dimensions
            y.domain(data.map(function(d) { return d.Major; })); 
            x.domain([0, d3.max(data, function(d){ return d.total; })]).nice();
            z.domain(keys);

            // Append rectangles to SVG for Mid-Career Salary Benchmarks
            g.append("g")
                .selectAll("g")
                .data(d3.stack().keys(keys)(data))
              .enter().append("g")
                .attr("fill", function(d) { return z(d.key); })
                .selectAll("rect")
                .data(function(d) { return d; })
              .enter().append("rect")
                .attr("y", function(d) { return y(d.data.Major); })
                .attr("x", function(d) {return x(d[0])+(.15*width); })  
                .attr("width", function(d) { return x(d[1]) - x(d[0]); })
                .attr("height", y.bandwidth())
                .on("mouseover", rect_mouseOver)
                .on("mouseout", mouseOut);

            // Append circles to SVG for Median Starting Salary
            g.append("g")
                .selectAll("circle")
                .data(data)
              .enter().append("circle")
                .attr("cy", function(d){ return y(d["Major"])+(0.5*y.bandwidth())})
                .attr("cx", function(d){ return x(d["Starting Median Salary"]) + (.15*width)}) 
                .attr("r", function(){
                    if(filter.length == 0)
                        return y.bandwidth()/3;
                    else
                        return y.bandwidth()/10;
                })
                .style("fill", "black")
                .style("opacity", 1)
                .on("mouseover", circle_mouseOver)
                .on("mouseout", mouseOut);

            // Append y-axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", "translate("+(.15*width)+",0)")   
                .style("font-size", function(){
                    if(filter.length == 0)
                        return "8px";
                    else
                        return "12px";
                })
                .call(d3.axisLeft(y));

            // Append x-axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", "translate("+(.15*width)+","+height+")")
                .call(d3.axisBottom(x).ticks(null, "s"))
            .append("text")
                .attr("y", 2)
                .attr("x", x(x.ticks().pop()) + 0.5)
                .attr("dy", "0.32em")
                .attr("fill", "#000")
                .attr("font-weight", "bold")
                .attr("text-anchor", "start")
                .text("Salary")
                .attr("transform", "translate("+ (-width - (.05*width)) +","+y.bandwidth()+")");

            // Append legend object
            var legend = g.append("g")
                            .attr("font-family", "sans-serif")
                            .attr("font-size", 10)
                            .attr("text-anchor", "end")
                            .selectAll("g")
                            .data(keys.slice().reverse())
                          .enter().append("g")
                            .attr("transform", function(d, i) { 
                                return "translate(0," + (300 + i * 20) + ")"; });

            // Append legend colored squares 
            legend.append("rect")
                .attr("x", width - 19)
                .attr("width", 19)
                .attr("height", 19)
                .attr("fill", z);

            // Append legend text
            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9.5)
                .attr("dy", "0.32em")
                .style("font-size", "8px")
                .style("font-weight", "bold")
                .text(function(d) { 
                    if(d == "Mid-Career 50th Percentile")
                        return "Mid-Career Median";
                    else
                        return d; });

            // Reset viz when you click anywhere   
            d3.select("#chartSVG").on("click", function(){
                d3.select("#chartSVG").remove();
                draw_bar([]);
            });
        }
    );
}

// Draw initial state of the viz
draw_map();
draw_bar([]);

</script>

</body>